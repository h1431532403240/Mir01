# 進貨管理功能 - 問題解決記錄

## 問題描述
在完成進貨管理功能後，出現以下錯誤：
1. TypeScript 編譯錯誤（找不到模組）
2. 前端顯示「獲取庫存列表失敗」錯誤

## 問題分析

### 1. TypeScript 編譯錯誤
**問題**：
- 找不到模組 `@/components/purchases/PurchaseManagement`
- 找不到模組 `./CreatePurchaseDialog`
- ProductSelector.tsx 中的 price 型別錯誤

**原因**：
- TypeScript 編譯器緩存問題
- price 欄位型別不匹配（number vs string）

**解決方案**：
- 修正 `ProductSelector.tsx` 中 `variant.price` 轉換為字串
- 改善錯誤處理的型別安全性

### 2. API 認證錯誤
**問題**：
- 前端顯示「獲取庫存列表失敗」
- API 返回認證錯誤

**原因**：
- 後端 API 需要 Sanctum token 認證
- 用戶未登入，無法獲得有效的 API token

**解決方案**：
- 改善錯誤處理，識別 401 認證錯誤
- 提供友善的錯誤訊息和登入引導
- 安裝 shadcn/ui Alert 元件顯示錯誤狀態

## 技術實作

### 1. 修正 ProductSelector 型別錯誤
```typescript
// 修正前
price: variant.price,

// 修正後
price: variant.price?.toString(),
```

### 2. 改善 API 錯誤處理
```typescript
// useInventoryList 中加入友善錯誤處理
if (error) {
  // 簡化錯誤處理，避免型別問題
  const errorString = String(error);
  if (errorString.includes('401') || errorString.includes('Unauthorized')) {
    throw new Error('請先登入以查看庫存資料');
  }
  throw new Error('獲取庫存列表失敗，請檢查網路連線或稍後再試');
}
```

### 3. 前端錯誤 UI
```tsx
{inventoryError ? (
  <div className="p-6">
    <Alert>
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>載入失敗</AlertTitle>
      <AlertDescription className="flex items-center justify-between">
        <span>{inventoryError.message}</span>
        {inventoryError.message?.includes('請先登入') && (
          <Button asChild size="sm" className="ml-4">
            <Link href="/login">
              <LogIn className="h-4 w-4 mr-2" />
              立即登入
            </Link>
          </Button>
        )}
      </AlertDescription>
    </Alert>
  </div>
) : (
  // 正常的庫存列表
)}
```

## 測試帳號
- **用戶名**：`superadmin`
- **密碼**：`password`
- **角色**：管理員

## 服務狀態
- **前端**：http://localhost:3001 ✅
- **後端**：http://localhost ✅
- **API 健康檢查**：http://localhost/api/health ✅

## 下一步操作指引
1. 開啟 http://localhost:3001/login
2. 使用測試帳號登入
3. 訪問 http://localhost:3001/inventory 查看庫存
4. 訪問 http://localhost:3001/purchases 測試進貨功能

## 修改的檔案清單
- `src/components/inventory/ProductSelector.tsx`
- `src/hooks/queries/useEntityQueries.ts`
- `src/components/inventory/InventoryManagement.tsx`
- 新增：`src/components/ui/alert.tsx`（透過 shadcn/ui CLI）

## 技術亮點
1. **型別安全**：確保 TypeScript 編譯無錯誤
2. **友善錯誤處理**：針對認證錯誤提供明確指引
3. **用戶體驗**：錯誤狀態下提供登入按鈕
4. **架構一致性**：遵循 shadcn/ui 設計系統

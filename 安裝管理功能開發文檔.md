# 安裝管理功能開發文檔

## 功能概述

安裝管理系統是一個獨立的模組，支援兩種建立方式：
1. 從現有訂單「一鍵導入」建立安裝單
2. 直接手工建立安裝單（適用於售後安裝、維修等場景）

採用解耦合的系統設計，安裝單可選擇性綁定 order_id，實現鬆耦合關聯。

## 階段一：後端 API 實施完成 ✅

### 實施狀態：已完成並測試通過

#### 測試結果
- ✅ 成功創建安裝單 (編號: I-202506-0001)
- ✅ 成功查詢安裝單列表
- ✅ 成功更新安裝單狀態 (pending → scheduled)
- ✅ 權限系統正常運作

#### API 文檔同步
- ✅ 修復了 Scribe 生成文檔的問題（修改了 field-details.blade.php 模板）
- ✅ 成功生成包含安裝管理 API 的 OpenAPI 文檔
- ✅ OpenAPI 文檔已同步到前端（inventory-client/openapi.yaml）
- ✅ 前端 API 類型定義已更新（src/types/api.ts）

#### 注意事項
1. 已為 User 模型添加 `hasAnyRole()` 方法以支援權限檢查
2. 已添加 `installer` 角色常數定義
3. API 功能已全部實現並可正常使用
4. 修復了 Scribe 處理複雜對象 example 的問題（修改 field-details.blade.php）
5. **重要原則**：保持後端 API 文檔的完整性，不應為了工具問題而簡化 example

### 1. 資料模型

#### Installation (安裝單主表)
```php
- id: 主鍵
- installation_number: 安裝單號 (格式: I-YYYYMM-XXXX)
- order_id: 可空，關聯的訂單ID
- customer_name: 客戶姓名
- customer_phone: 客戶電話
- installation_address: 安裝地址
- installer_user_id: 分配的安裝師傅
- status: pending|scheduled|in_progress|completed|cancelled
- scheduled_date: 預計安裝日期
- actual_start_time: 實際開始時間
- actual_end_time: 實際結束時間
- notes: 安裝備註
- created_by: 建立者
```

#### InstallationItem (安裝項目)
```php
- id: 主鍵
- installation_id: 安裝單ID
- order_item_id: 可空，來源訂單項目ID
- product_name: 商品名稱
- sku: 商品編號
- quantity: 安裝數量
- specifications: 安裝規格說明
- status: pending|completed
- notes: 項目備註
```

### 2. API 端點

#### 安裝單管理
- `GET /api/installations` - 獲取安裝單列表
- `POST /api/installations` - 建立新安裝單
- `GET /api/installations/{id}` - 查看安裝單詳情
- `PUT /api/installations/{id}` - 更新安裝單
- `DELETE /api/installations/{id}` - 刪除安裝單

#### 從訂單建立
- `POST /api/installations/create-from-order` - 從訂單建立安裝單

#### 狀態管理
- `POST /api/installations/{id}/assign` - 分配安裝師傅
- `POST /api/installations/{id}/status` - 更新安裝單狀態

#### 行程管理
- `GET /api/installations/schedule` - 獲取安裝師傅的行程

### 3. 權限設計

#### admin 角色
- 全部安裝管理權限

#### installer 角色
- 查看分配給自己的安裝任務
- 更新安裝進度
- 查看行事曆

#### staff 角色
- 建立安裝單
- 查看所有安裝狀態
- 分配師傅

#### viewer 角色
- 僅查看安裝狀態

### 4. 業務邏輯

#### 狀態轉換規則
```
pending → scheduled → in_progress → completed
   ↓           ↓            ↓
cancelled   cancelled    cancelled
```

#### 自動化行為
- 分配師傅時，如果狀態為 pending，自動轉為 scheduled
- 狀態轉為 in_progress 時，自動記錄開始時間
- 狀態轉為 completed 時，自動記錄結束時間
- 所有項目完成時，自動將安裝單標記為完成

### 5. 與訂單系統的整合

- Order 模型新增 `installations()` 關聯方法
- 支援從訂單一鍵建立安裝單
- 安裝單可選擇性關聯訂單（鬆耦合設計）
- 客戶資訊冗餘存儲，支援獨立運作

## 待實施階段

### 階段二：前端安裝管理頁面

#### 實施計劃
1. **建立前端類型定義**
   - 在 `inventory-client/src/types/installation.ts` 定義類型
   - 使用現有的 api-helpers.ts 進行 API 調用

2. **建立 React Query hooks**
   - `useInstallations` - 查詢安裝單列表
   - `useInstallation` - 查詢單一安裝單
   - `useCreateInstallation` - 創建安裝單
   - `useUpdateInstallation` - 更新安裝單

3. **實現頁面組件**
   - `/installations` - 安裝單列表頁面 (DataTable + 篩選)
   - `/installations/[id]` - 安裝單詳情頁面
   - `/installations/new` - 新增安裝單表單
   - `/installations/[id]/edit` - 編輯安裝單表單

4. **整合到側邊欄**
   - 在 app-sidebar.tsx 添加安裝管理選單項目

### 階段三：行事曆功能實現
- 整合 react-big-calendar
- 月/週/日視圖切換
- 拖拽調整時間
- 衝突檢測和警告

### 階段四：與訂單系統的整合連結
- 訂單詳情頁面新增「相關安裝」區塊
- 訂單操作選單新增「建立安裝單」選項
- 雙向超連結導航

## 技術實施細節

### 使用的設計模式
1. **Service Layer Pattern**: InstallationService 處理複雜業務邏輯
2. **Repository Pattern**: 使用 Eloquent ORM
3. **Policy Pattern**: 細粒度權限控制
4. **Resource Pattern**: API 資源轉換

### 遵循的架構原則
1. **契約優先**: 完整的 Request 驗證和 Resource 轉換
2. **權限分離**: 基於角色的權限控制
3. **解耦合設計**: 安裝系統可獨立於訂單系統運作
4. **資料冗餘**: 關鍵資訊冗餘存儲，確保系統穩定性

## API 使用範例

### 建立安裝單
```json
POST /api/installations
{
    "customer_name": "王小明",
    "customer_phone": "0912345678",
    "installation_address": "台北市信義區信義路五段7號",
    "scheduled_date": "2025-06-25",
    "items": [
        {
            "product_name": "辦公桌",
            "sku": "DESK-001",
            "quantity": 2,
            "specifications": "靠窗安裝"
        }
    ]
}
```

### 從訂單建立安裝單
```json
POST /api/installations/create-from-order
{
    "order_id": 1,
    "order_item_ids": [1, 2, 3],
    "scheduled_date": "2025-06-25",
    "installer_user_id": 2
}
```

### 更新安裝狀態
```json
POST /api/installations/1/status
{
    "status": "in_progress"
}
```

## Scribe 文檔生成錯誤修復記錄（2025-06-24）

### 修復的問題

1. **UpdateCustomerRequest 路由參數錯誤**
   - 錯誤：`Attempt to read property "id" on null`
   - 原因：直接訪問 `$this->route('customer')->id` 時沒有檢查 null
   - 修復：添加 null 檢查
   ```php
   $customer = $this->route('customer');
   $customerId = $customer ? $customer->id : null;
   ```

2. **缺少 bodyParameters() 方法的 Request 類**
   - 修復了以下 Request 類：
     - BatchDeleteOrdersRequest
     - BatchUpdateStatusRequest
     - StoreProductRequest（已有）
     - AddPaymentRequest
     - CreateInstallationFromOrderRequest
     - UpdateCustomerRequest
     - UploadProductImageRequest
     - UpdateOrderRequest
     - CreateRefundRequest
     - UpdateOrderItemStatusRequest
     - InventoryTimeSeriesRequest
     - StoreInstallationRequest
     - UpdateInstallationRequest

### 修復方法

為每個缺少 `bodyParameters()` 方法的 Request 類添加了該方法，格式如下：

```php
/**
 * 取得請求體參數的文檔
 * 
 * 用於 Scribe API 文檔生成
 * 
 * @return array
 */
public function bodyParameters(): array
{
    return [
        'field_name' => [
            'description' => '欄位描述',
            'example' => '範例值',
        ],
        // ... 其他欄位
    ];
}
```

### 結果

- 所有 Scribe 文檔生成錯誤已修復
- API 文檔成功生成：http://localhost/docs
- OpenAPI 規格檔案成功生成：storage/app/private/scribe/openapi.yaml 

## 7. 階段二實施記錄

### 已完成的前端功能（2024-12-XX）

#### 建立的檔案結構：
```
inventory-client/
├── src/
│   ├── types/
│   │   └── installation.ts                    # 安裝管理類型定義
│   ├── hooks/queries/
│   │   └── useEntityQueries.ts                # 新增安裝管理 hooks
│   ├── components/installations/
│   │   ├── columns.tsx                        # DataTable 欄位定義
│   │   └── InstallationClientComponent.tsx    # 主要客戶端組件
│   └── app/(app)/installations/
│       └── page.tsx                           # 安裝管理主頁面
```

#### 實現的功能：

1. **類型定義 (installation.ts)**
   - Installation 主體介面
   - InstallationItem 項目介面
   - 狀態枚舉和對應表
   - 各種請求和回應的類型定義

2. **React Query Hooks**
   - useInstallations - 獲取安裝單列表
   - useInstallation - 獲取單一安裝單
   - useCreateInstallation - 建立安裝單
   - useCreateInstallationFromOrder - 從訂單建立安裝單
   - useUpdateInstallation - 更新安裝單
   - useDeleteInstallation - 刪除安裝單
   - useAssignInstaller - 分配安裝師傅
   - useUpdateInstallationStatus - 更新狀態
   - useInstallationSchedule - 獲取安裝行程

3. **列表頁面功能**
   - 資料表格展示（使用 TanStack Table）
   - 多條件篩選（狀態、師傅、日期範圍）
   - 搜尋功能（支援安裝單號、客戶名稱）
   - 分頁功能
   - 統計卡片（總數、待排程、進行中、本月完成）
   - 批量選擇功能

4. **操作功能**
   - 快速預覽（開發中）
   - 分配師傅（開發中）
   - 更新狀態（開發中）
   - 查看關聯訂單
   - 編輯安裝單
   - 刪除安裝單（含權限控制）

5. **導航整合**
   - 在側邊欄添加「安裝管理」選單
   - 使用 IconTool 圖標

#### 技術實現細節：

1. **遵循架構規範**
   - 使用 React Query 進行資料管理
   - 實現「失效並強制重取」的快取策略
   - 完整的類型安全，無 any 類型
   - 使用 sonner 進行通知回饋

2. **UI/UX 優化**
   - 使用 Shadcn/UI 組件庫
   - 響應式設計
   - 載入骨架屏
   - 友善的錯誤處理

3. **權限控制**
   - 根據安裝單狀態控制操作權限
   - 只有待排程和已取消的安裝單可以刪除
   - 已完成和已取消的安裝單不能更新狀態

### 待實現功能：

1. **詳情頁面** (/installations/[id])
   - 顯示完整的安裝單資訊
   - 安裝項目列表
   - 狀態變更歷史
   - 操作按鈕

2. **新增/編輯表單** (/installations/new, /installations/[id]/edit)
   - 客戶資訊輸入
   - 安裝項目管理
   - 地址選擇
   - 日期時間選擇器

3. **快速預覽對話框**
   - 顯示關鍵資訊
   - 快速操作按鈕

4. **分配師傅對話框**
   - 師傅列表
   - 排程日期選擇
   - 衝突檢測

5. **更新狀態對話框**
   - 狀態選擇
   - 時間記錄（開始/結束時間）
   - 備註輸入

### API 契約同步狀態：
✅ 後端 API 已實現
✅ OpenAPI 文檔已生成
✅ 前端類型已同步
✅ Hooks 已實現
✅ 列表頁面已完成

### 下一步計劃：
1. 實現安裝單詳情頁面
2. 實現新增/編輯表單
3. 完成各種操作對話框
4. 與訂單系統的整合（在訂單詳情頁顯示相關安裝）
5. 實現行事曆視圖（階段三）

## 8. API 類型同步問題修復記錄（2025-06-25）

### 遇到的問題

在前端開發過程中，發現 TypeScript 編譯錯誤：
1. `scheduled_date` 類型為 `Record<string, never>` 而非 `string`
2. `customer_phone` 的 nullable 類型問題
3. 其他日期相關字段的類型錯誤

### 問題原因

Scribe 在生成 OpenAPI 文檔時，對於 PHPDoc 註釋中的 `date` 和 `datetime` 類型，生成了非標準的 OpenAPI 類型定義（`type: date` 而非 `type: string` with `format: date`）。

### 解決方案

1. **修改控制器 PHPDoc 註釋**
   - 將所有 `@bodyParam` 註釋中的 `date` 改為 `string`
   - 將所有 `@bodyParam` 註釋中的 `datetime` 改為 `string`

2. **更新 Form Request 的 bodyParameters() 方法**
   - 為所有參數添加明確的 `type` 屬性
   - 對日期字段使用 `type: string` 和 `format: date` 或 `format: date-time`
   - 添加 `required` 屬性以明確必填狀態

3. **重新生成文檔和類型**
   ```bash
   # 後端生成 API 文檔
   ./vendor/bin/sail artisan scribe:generate
   
   # 複製到前端
   cp storage/app/private/scribe/openapi.yaml ../inventory-client/openapi.yaml
   
   # 前端生成類型
   npm run api:types
   ```

### 修改的檔案

1. **app/Http/Controllers/Api/InstallationController.php**
   - 修改了所有日期相關的 PHPDoc 註釋

2. **app/Http/Requests/Api/StoreInstallationRequest.php**
   - 更新了 bodyParameters() 方法，添加類型定義

3. **app/Http/Requests/Api/UpdateInstallationRequest.php**
   - 更新了 bodyParameters() 方法，添加類型定義

4. **app/Http/Requests/Api/CreateInstallationFromOrderRequest.php**
   - 更新了 bodyParameters() 方法，添加類型定義

### 結果

✅ API 類型成功生成
✅ `scheduled_date` 現在正確地為 `string | null` 類型
✅ 所有日期字段類型正確
✅ 前端 TypeScript 編譯錯誤已解決

### 經驗總結

1. **Scribe 的限制**：Scribe 在處理 bodyParameters() 方法時，可能不完全支援 OpenAPI 的所有類型定義特性。

2. **最佳實踐**：
   - 在 PHPDoc 註釋中使用 `string` 而非 `date` 或 `datetime`
   - 在 bodyParameters() 方法中明確指定 `type`、`format` 和 `required` 屬性
   - 定期檢查生成的 OpenAPI 文檔，確保類型定義正確
   - 對於 GET 請求的查詢參數，創建專門的 Request 類來處理驗證

3. **Laravel Sail 使用**：記得使用 `./vendor/bin/sail` 而非直接使用 `php` 命令

## 9. GET 請求 RequestBody 問題修復（2025-06-25）

### 問題描述
`/api/installations/schedule` 的 GET 請求被 Scribe 錯誤地生成了 `requestBody`，導致前端 TypeScript 類型錯誤：
```
類型 '{ params: { query: any; }; }' 的引數不可指派給類型 '{ params: { query: {...}; }; } & { body: {...}; }' 的參數。
類型 '{ params: { query: any; }; }' 缺少屬性 'body'
```

### 問題原因
Scribe 在處理控制器方法中的 `$request->validate()` 時，錯誤地將驗證規則當作 requestBody 參數，而非查詢參數。

### 解決方案

1. **創建專門的 Request 類**
   ```php
   // app/Http/Requests/Api/GetInstallationScheduleRequest.php
   class GetInstallationScheduleRequest extends FormRequest
   {
       public function rules(): array
       {
           return [
               'installer_user_id' => ['required', 'integer', 'exists:users,id'],
               'start_date' => ['required', 'date'],
               'end_date' => ['required', 'date', 'after_or_equal:start_date']
           ];
       }
       
       public function queryParameters(): array
       {
           return [
               'installer_user_id' => [
                   'description' => '安裝師傅的用戶ID',
                   'example' => 1,
               ],
               // ... 其他參數
           ];
       }
   }
   ```

2. **更新控制器方法**
   - 使用專門的 Request 類型而非直接使用 `Request`
   - 移除 `$request->validate()` 調用

3. **修正前端查詢參數構建**
   - 不使用 `filter[]` 前綴，直接使用參數名稱

### 結果
✅ GET 請求不再包含 requestBody
✅ 前端 TypeScript 類型錯誤已解決
✅ API 調用正常運作

## 10. 日期類型標準化（2025-06-26）

### 背景
根據 Scribe 官方文檔，`@bodyParam` 和 `@queryParam` 標籤只支援以下類型：
- `string`
- `integer`/`int`
- `number`
- `boolean`/`bool`
- `object`
- `file`

**`date` 和 `datetime` 並不是 Scribe 支援的標準類型**。雖然 Scribe 不會報錯，但會將這些非標準類型直接保留在 OpenAPI 文檔中，導致前端類型生成問題。

### 決定
為了避免多人協作時的混淆，決定將所有日期類型統一使用 `string` 類型，並在描述中說明格式：
- 日期：使用 `string` 類型，說明格式為 `Y-m-d`
- 日期時間：使用 `string` 類型，說明格式為 `Y-m-d H:i:s`

### 實施
已將 InstallationController 中的所有日期相關類型從 `date` 和 `datetime` 改為 `string`：

```php
// 之前
@bodyParam scheduled_date date 預計安裝日期（可選）。Example: 2025-06-25
@bodyParam actual_start_time datetime 實際開始時間。Example: 2025-06-25 09:00:00

// 之後
@bodyParam scheduled_date string 預計安裝日期（可選，格式：Y-m-d）。Example: 2025-06-25
@bodyParam actual_start_time string 實際開始時間（格式：Y-m-d H:i:s）。Example: 2025-06-25 09:00:00
```

### 結果
✅ 遵循 Scribe 官方支援的類型
✅ 無需額外的類型修復腳本
✅ 團隊協作更加清晰一致
✅ TypeScript 類型生成正確 
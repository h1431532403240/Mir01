# 安裝管理功能開發文檔

## 功能概述

安裝管理系統是一個獨立的模組，支援兩種建立方式：
1. 從現有訂單「一鍵導入」建立安裝單
2. 直接手工建立安裝單（適用於售後安裝、維修等場景）

採用解耦合的系統設計，安裝單可選擇性綁定 order_id，實現鬆耦合關聯。

## 階段一：後端 API 實施完成 ✅

### 實施狀態：已完成並測試通過

#### 測試結果
- ✅ 成功創建安裝單 (編號: I-202506-0001)
- ✅ 成功查詢安裝單列表
- ✅ 成功更新安裝單狀態 (pending → scheduled)
- ✅ 權限系統正常運作

#### API 文檔同步
- ✅ 修復了 Scribe 生成文檔的問題（修改了 field-details.blade.php 模板）
- ✅ 成功生成包含安裝管理 API 的 OpenAPI 文檔
- ✅ OpenAPI 文檔已同步到前端（inventory-client/openapi.yaml）
- ✅ 前端 API 類型定義已更新（src/types/api.ts）

#### 注意事項
1. 已為 User 模型添加 `hasAnyRole()` 方法以支援權限檢查
2. 已添加 `installer` 角色常數定義
3. API 功能已全部實現並可正常使用
4. 修復了 Scribe 處理複雜對象 example 的問題（修改 field-details.blade.php）
5. **重要原則**：保持後端 API 文檔的完整性，不應為了工具問題而簡化 example

### 1. 資料模型

#### Installation (安裝單主表)
```php
- id: 主鍵
- installation_number: 安裝單號 (格式: I-YYYYMM-XXXX)
- order_id: 可空，關聯的訂單ID
- customer_name: 客戶姓名
- customer_phone: 客戶電話
- installation_address: 安裝地址
- installer_user_id: 分配的安裝師傅
- status: pending|scheduled|in_progress|completed|cancelled
- scheduled_date: 預計安裝日期
- actual_start_time: 實際開始時間
- actual_end_time: 實際結束時間
- notes: 安裝備註
- created_by: 建立者
```

#### InstallationItem (安裝項目)
```php
- id: 主鍵
- installation_id: 安裝單ID
- order_item_id: 可空，來源訂單項目ID
- product_name: 商品名稱
- sku: 商品編號
- quantity: 安裝數量
- specifications: 安裝規格說明
- status: pending|completed
- notes: 項目備註
```

### 2. API 端點

#### 安裝單管理
- `GET /api/installations` - 獲取安裝單列表
- `POST /api/installations` - 建立新安裝單
- `GET /api/installations/{id}` - 查看安裝單詳情
- `PUT /api/installations/{id}` - 更新安裝單
- `DELETE /api/installations/{id}` - 刪除安裝單

#### 從訂單建立
- `POST /api/installations/create-from-order` - 從訂單建立安裝單

#### 狀態管理
- `POST /api/installations/{id}/assign` - 分配安裝師傅
- `POST /api/installations/{id}/status` - 更新安裝單狀態

#### 行程管理
- `GET /api/installations/schedule` - 獲取安裝師傅的行程

### 3. 權限設計

#### admin 角色
- 全部安裝管理權限

#### installer 角色
- 查看分配給自己的安裝任務
- 更新安裝進度
- 查看行事曆

#### staff 角色
- 建立安裝單
- 查看所有安裝狀態
- 分配師傅

#### viewer 角色
- 僅查看安裝狀態

### 4. 業務邏輯

#### 狀態轉換規則
```
pending → scheduled → in_progress → completed
   ↓           ↓            ↓
cancelled   cancelled    cancelled
```

#### 自動化行為
- 分配師傅時，如果狀態為 pending，自動轉為 scheduled
- 狀態轉為 in_progress 時，自動記錄開始時間
- 狀態轉為 completed 時，自動記錄結束時間
- 所有項目完成時，自動將安裝單標記為完成

### 5. 與訂單系統的整合

- Order 模型新增 `installations()` 關聯方法
- 支援從訂單一鍵建立安裝單
- 安裝單可選擇性關聯訂單（鬆耦合設計）
- 客戶資訊冗餘存儲，支援獨立運作

## 待實施階段

### 階段二：前端安裝管理頁面

#### 實施計劃
1. **建立前端類型定義**
   - 在 `inventory-client/src/types/installation.ts` 定義類型
   - 使用現有的 api-helpers.ts 進行 API 調用

2. **建立 React Query hooks**
   - `useInstallations` - 查詢安裝單列表
   - `useInstallation` - 查詢單一安裝單
   - `useCreateInstallation` - 創建安裝單
   - `useUpdateInstallation` - 更新安裝單

3. **實現頁面組件**
   - `/installations` - 安裝單列表頁面 (DataTable + 篩選)
   - `/installations/[id]` - 安裝單詳情頁面
   - `/installations/new` - 新增安裝單表單
   - `/installations/[id]/edit` - 編輯安裝單表單

4. **整合到側邊欄**
   - 在 app-sidebar.tsx 添加安裝管理選單項目

### 階段三：行事曆功能實現
- 整合 react-big-calendar
- 月/週/日視圖切換
- 拖拽調整時間
- 衝突檢測和警告

### 階段四：與訂單系統的整合連結
- 訂單詳情頁面新增「相關安裝」區塊
- 訂單操作選單新增「建立安裝單」選項
- 雙向超連結導航

## 技術實施細節

### 使用的設計模式
1. **Service Layer Pattern**: InstallationService 處理複雜業務邏輯
2. **Repository Pattern**: 使用 Eloquent ORM
3. **Policy Pattern**: 細粒度權限控制
4. **Resource Pattern**: API 資源轉換

### 遵循的架構原則
1. **契約優先**: 完整的 Request 驗證和 Resource 轉換
2. **權限分離**: 基於角色的權限控制
3. **解耦合設計**: 安裝系統可獨立於訂單系統運作
4. **資料冗餘**: 關鍵資訊冗餘存儲，確保系統穩定性

## API 使用範例

### 建立安裝單
```json
POST /api/installations
{
    "customer_name": "王小明",
    "customer_phone": "0912345678",
    "installation_address": "台北市信義區信義路五段7號",
    "scheduled_date": "2025-06-25",
    "items": [
        {
            "product_name": "辦公桌",
            "sku": "DESK-001",
            "quantity": 2,
            "specifications": "靠窗安裝"
        }
    ]
}
```

### 從訂單建立安裝單
```json
POST /api/installations/create-from-order
{
    "order_id": 1,
    "order_item_ids": [1, 2, 3],
    "scheduled_date": "2025-06-25",
    "installer_user_id": 2
}
```

### 更新安裝狀態
```json
POST /api/installations/1/status
{
    "status": "in_progress"
}
```

## Scribe 文檔生成錯誤修復記錄（2025-06-24）

### 修復的問題

1. **UpdateCustomerRequest 路由參數錯誤**
   - 錯誤：`Attempt to read property "id" on null`
   - 原因：直接訪問 `$this->route('customer')->id` 時沒有檢查 null
   - 修復：添加 null 檢查
   ```php
   $customer = $this->route('customer');
   $customerId = $customer ? $customer->id : null;
   ```

2. **缺少 bodyParameters() 方法的 Request 類**
   - 修復了以下 Request 類：
     - BatchDeleteOrdersRequest
     - BatchUpdateStatusRequest
     - StoreProductRequest（已有）
     - AddPaymentRequest
     - CreateInstallationFromOrderRequest
     - UpdateCustomerRequest
     - UploadProductImageRequest
     - UpdateOrderRequest
     - CreateRefundRequest
     - UpdateOrderItemStatusRequest
     - InventoryTimeSeriesRequest
     - StoreInstallationRequest
     - UpdateInstallationRequest

### 修復方法

為每個缺少 `bodyParameters()` 方法的 Request 類添加了該方法，格式如下：

```php
/**
 * 取得請求體參數的文檔
 * 
 * 用於 Scribe API 文檔生成
 * 
 * @return array
 */
public function bodyParameters(): array
{
    return [
        'field_name' => [
            'description' => '欄位描述',
            'example' => '範例值',
        ],
        // ... 其他欄位
    ];
}
```

### 結果

- 所有 Scribe 文檔生成錯誤已修復
- API 文檔成功生成：http://localhost/docs
- OpenAPI 規格檔案成功生成：storage/app/private/scribe/openapi.yaml 